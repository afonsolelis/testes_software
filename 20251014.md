# Integração com Testcontainers - 14/10/2025

Este documento descreve a implementação de testes de integração usando Testcontainers para a aplicação de cadastro de estudantes.

## O que são Testcontainers?

Testcontainers é uma biblioteca Java que permite executar containers Docker durante os testes, fornecendo instâncias reais de bancos de dados, serviços de mensageria, caches e outros serviços em um ambiente isolado.

## Benefícios dos Testcontainers

1. **Ambiente Real**: Testa com o mesmo banco de dados usado em produção
2. **Isolamento**: Cada teste roda em um container isolado
3. **Reprodutibilidade**: Garante que os testes funcionem em qualquer ambiente
4. **Sem Configuração Manual**: Não precisa configurar bancos de dados externos
5. **Limpeza Automática**: Containers são removidos automaticamente após os testes

## Implementação

### 1. Dependências Adicionadas

```xml
<!-- Testcontainers dependencies -->
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>junit-jupiter</artifactId>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>postgresql</artifactId>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-testcontainers</artifactId>
    <scope>test</scope>
</dependency>
```

### 2. Configuração do Testcontainer

O `AlunoIntegrationTest` configura um container PostgreSQL usando Testcontainers:

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@Testcontainers
class AlunoIntegrationTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15-alpine")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
    }
}
```

### 3. Testes Implementados

#### Teste de Criação de Aluno
```java
@Test
@Order(1)
void testCreateAluno() {
    // Given
    Aluno aluno = new Aluno("João Silva", 25, "joao@senac.com");
    
    // When
    ResponseEntity<Aluno> response = restTemplate.postForEntity(
        "/api/v1/alunos", aluno, Aluno.class);
    
    // Then
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
    assertThat(response.getBody()).isNotNull();
    assertThat(response.getBody().getNome()).isEqualTo("João Silva");
    assertThat(response.getBody().getEmail()).isEqualTo("joao@senac.com");
}
```

#### Teste de Validação de Email
```java
@Test
@Order(2)
void testCreateAlunoWithInvalidEmail() {
    // Given
    Aluno aluno = new Aluno("Maria Silva", 22, "maria@email.com");
    
    // When
    ResponseEntity<String> response = restTemplate.postForEntity(
        "/api/v1/alunos", aluno, String.class);
    
    // Then
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.BAD_REQUEST);
    assertThat(response.getBody()).contains("Email inválido");
}
```

#### Teste de Listagem de Alunos
```java
@Test
@Order(3)
void testGetAllAlunos() {
    // When
    ResponseEntity<Aluno[]> response = restTemplate.getForEntity(
        "/api/v1/alunos", Aluno[].class);
    
    // Then
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
    assertThat(response.getBody()).hasSize(1);
    assertThat(response.getBody()[0].getNome()).isEqualTo("João Silva");
}
```

#### Teste de Atualização de Aluno
```java
@Test
@Order(4)
void testUpdateAluno() {
    // Given
    Aluno alunoAtualizado = new Aluno("João Silva Atualizado", 26, "joao.atualizado@senac.com");
    
    // When
    ResponseEntity<Aluno> response = restTemplate.exchange(
        "/api/v1/alunos/1", HttpMethod.PUT, 
        new HttpEntity<>(alunoAtualizado), Aluno.class);
    
    // Then
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
    assertThat(response.getBody().getNome()).isEqualTo("João Silva Atualizado");
}
```

#### Teste de Exclusão de Aluno
```java
@Test
@Order(5)
void testDeleteAluno() {
    // When
    ResponseEntity<String> response = restTemplate.exchange(
        "/api/v1/alunos/1", HttpMethod.DELETE, 
        new HttpEntity<>(null), String.class);
    
    // Then
    assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
    assertThat(response.getBody()).contains("Aluno deletado com sucesso");
}
```

## Como Executar os Testes

### Via Maven
```bash
mvn test
```

### Via PowerShell
```powershell
mvn test
```

### Executar apenas os testes de integração
```bash
mvn test -Dtest=AlunoIntegrationTest
```

## Estrutura dos Testes

```
src/test/java/com/example/studentregistration/
└── AlunoIntegrationTest.java
```

## Configuração do Container

- **Imagem**: `postgres:15-alpine` (PostgreSQL 15 em Alpine Linux)
- **Database**: `testdb`
- **Username**: `test`
- **Password**: `test`
- **Porta**: Aleatória (gerenciada pelo Testcontainers)

## Vantagens desta Implementação

1. **Testes Realistas**: Usa PostgreSQL real, não H2 em memória
2. **Isolamento**: Cada execução de teste tem seu próprio banco
3. **Ordem dos Testes**: Usa `@Order` para garantir sequência lógica
4. **Limpeza Automática**: Container é removido automaticamente
5. **Configuração Dinâmica**: URLs são configuradas dinamicamente

## Próximos Passos

1. Adicionar mais cenários de teste
2. Implementar testes de performance
3. Adicionar testes de concorrência
4. Configurar relatórios de cobertura
5. Integrar com CI/CD

## Referências

- [Testcontainers Documentation](https://www.testcontainers.org/)
- [Spring Boot Testcontainers](https://spring.io/guides/gs/testing-web/)
- [PostgreSQL Testcontainer](https://www.testcontainers.org/modules/databases/postgresql/)
